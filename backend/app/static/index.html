<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Dialogs Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì±</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Telegram Dialogs Viewer</div>
            <div id="user-info" style="display: none;">
                <span id="user-name"></span>
                <button id="logout-button" class="auth-button">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </header>

    <main class="container">
        <section id="auth-section" class="auth-section">
            <div class="auth-card">
                <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram.</p>
                
                <!-- –í–∫–ª–∞–¥–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
                <div class="auth-tabs">
                    <button class="auth-tab-button active" data-tab="telegram-tab">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</button>
                    <button class="auth-tab-button" data-tab="phone-tab">–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</button>
                    <button class="auth-tab-button" data-tab="manual-tab">–¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥</button>
                </div>
                
                <div class="auth-tab-content">
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Å –±—ã—Å—Ç—Ä—ã–º –≤—Ö–æ–¥–æ–º —á–µ—Ä–µ–∑ Telegram -->
                    <div id="telegram-tab" class="auth-tab-pane active">
                        <div class="auth-methods">
                            <div id="telegram-login">
                                <!-- –í–∏–¥–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            <p>–∏–ª–∏</p>
                            <a href="tg://resolve?domain=EnigmaSecretMessages_bot" class="auth-button telegram-button">
                                –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
                            </a>
                        </div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Å –≤—Ö–æ–¥–æ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É -->
                    <div id="phone-tab" class="auth-tab-pane">
                        <div class="phone-auth">
                            <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ –∏–∑ Telegram -->
                            <div class="warning-message">
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–π–¥–µ–Ω—ã –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Telegram –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ API Telegram.
                            </div>
                            
                            <!-- –®–∞–≥ 1: –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
                            <div id="phone-step" class="auth-step">
                                <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:</p>
                                <input type="tel" id="phone-number" placeholder="+79001234567" class="auth-input">
                                <button id="send-code-button" class="auth-button">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                            </div>
                            
                            <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                            <div id="code-step" class="auth-step" style="display: none;">
                                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤ Telegram:</p>
                                <input type="text" id="confirmation-code" placeholder="12345" class="auth-input">
                                <button id="verify-code-button" class="auth-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                                <button id="back-to-phone-button" class="auth-button secondary">–ù–∞–∑–∞–¥</button>
                            </div>
                            
                            <!-- –®–∞–≥ 3: –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è (–¥–ª—è 2FA) -->
                            <div id="password-step" class="auth-step" style="display: none;">
                                <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:</p>
                                <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="auth-input">
                                <button id="verify-password-button" class="auth-button">–í–æ–π—Ç–∏</button>
                                <button id="back-to-code-button" class="auth-button secondary">–ù–∞–∑–∞–¥</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º –≤—Ö–æ–¥–æ–º -->
                    <div id="manual-tab" class="auth-tab-pane">
                        <div class="manual-auth">
                            <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</p>
                            <input type="text" id="telegram-id" placeholder="–í–∞—à Telegram ID" class="auth-input">
                            <button id="manual-auth-button" class="auth-button">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="dialogs-section" class="dialogs-section">
            <h2>–í–∞—à–∏ –¥–∏–∞–ª–æ–≥–∏</h2>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>
            <div id="dialogs-list" class="dialog-list"></div>
        </section>

        <section id="messages-section" class="messages-section">
            <div class="messages-header">
                <button id="back-to-dialogs" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∏–∞–ª–æ–≥–∞–º</button>
                <h2 id="current-dialog-header">–î–∏–∞–ª–æ–≥</h2>
            </div>
            <div class="enigma-key-container">
                <label for="enigma-key">–ö–ª—é—á:</label>
                <input type="text" id="enigma-key" class="enigma-key-input" maxlength="5" placeholder="–í–≤–µ–¥–∏—Ç–µ 5 —Å–∏–º–≤–æ–ª–æ–≤">
                <div id="key-validation-message" class="key-validation-message"></div>
            </div>
            <div id="messages-list" class="messages-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="message-input-container">
                <input type="text" id="message-input" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button id="send-message" class="send-button" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855a.5.5 0 0 0-.042.971l4.988 1.687 1.687 4.988a.5.5 0 0 0 .971-.042l5.818-14.316z"/>
                    </svg>
                </button>
            </div>
        </section>

        <section id="debug-section" class="debug-section">
            <h2>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div id="debug-info" class="debug-info">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ...</p>
            </div>
            <div class="auth-debug">
                <h3>–û—Ç–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div id="auth-debug-info" class="debug-info">
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
                </div>
                <button id="check-auth-button" class="auth-button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
                <button id="clear-auth-button" class="auth-button">–û—á–∏—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            </div>
            <div class="telegram-sessions-debug">
                <h3>–û—Ç–ª–∞–¥–∫–∞ —Å–µ—Å—Å–∏–π Telegram</h3>
                <div id="sessions-debug-info" class="debug-info">
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Å—Å–∏—è—Ö</p>
                </div>
                <button id="check-sessions-button" class="auth-button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏–∏</button>
            </div>
            <div class="webhook-controls">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–º</h3>
                <button id="set-webhook-button" class="auth-button">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫</button>
                <button id="delete-webhook-button" class="auth-button">–£–¥–∞–ª–∏—Ç—å –≤–µ–±—Ö—É–∫</button>
                <button id="refresh-info-button" class="auth-button">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
            </div>
            <div class="test-message-controls">
                <h3>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                <input type="text" id="test-chat-id" placeholder="ID —á–∞—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è">
                <button id="send-test-message-button" class="auth-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            </div>
            <div class="direct-auth">
                <h3>–ü—Ä—è–º–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                <button id="direct-auth-button" class="auth-button">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é</button>
            </div>
            <div class="sipay-message">
                <h3>Sipay</h3>
                <button id="sipay-button" class="auth-button">Sipay</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div>&copy; 2025 Telegram Dialogs Viewer</div>
            <div class="footer-links">
                <a href="/docs" target="_blank">API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>
                <a href="https://github.com/askulibaba/telegram-dialogs-viewer" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showLoginForm() {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dialogs-section').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                userInfo.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        function showTelegramAuthForm() {
            const phoneTab = document.querySelector('.auth-tab-button[data-tab="phone-tab"]');
            if (phoneTab) {
                phoneTab.click();
            }
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dialogs-section').style.display = 'none';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ
        async function loadBotInfo() {
            try {
                const response = await fetch('/bot-info');
                const data = await response.json();
                
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.innerHTML = `
                        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
                
                // –ï—Å–ª–∏ –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (data.bot_info && data.bot_info.ok) {
                    const botUsername = data.bot_info.result.username;
                    const telegramLogin = document.getElementById('telegram-login');
                    
                    if (telegramLogin) {
                        // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        telegramLogin.innerHTML = '';
                        
                        // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
                        const script = document.createElement('script');
                        script.async = true;
                        script.src = 'https://telegram.org/js/telegram-widget.js?22';
                        script.setAttribute('data-telegram-login', botUsername);
                        script.setAttribute('data-size', 'large');
                        script.setAttribute('data-auth-url', `${window.location.origin}/api/v1/auth/telegram`);
                        script.setAttribute('data-request-access', 'write');
                        script.setAttribute('data-onauth', 'telegramLogin');
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        telegramLogin.appendChild(script);
                        
                        console.log('–í–∏–¥–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram –¥–æ–±–∞–≤–ª–µ–Ω:', botUsername);
                    }
                } else {
                    console.error('–ë–æ—Ç –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                }
                
                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ:', error);
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.innerHTML = `
                        <h3>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ:</h3>
                        <pre>${error.message}</pre>
                    `;
                }
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–µ–±—Ö—É–∫–∞
        async function setWebhook() {
            try {
                const response = await fetch('/set-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–µ–±—Ö—É–∫–∞:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
                await loadBotInfo();
                
                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞:', error);
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–∞
        async function deleteWebhook() {
            try {
                const response = await fetch('/delete-webhook', {
                    method: 'POST'
                });
                
                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–∞:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
                await loadBotInfo();
                
                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞:', error);
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendTestMessage(chatId) {
            try {
                const response = await fetch('/send-test-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId
                    })
                });
                
                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', data);
                
                return data;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è "–•—Ä–µ–Ω" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID 832190149
        async function sendSipayMessage() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram
                const checkResponse = await fetch('/api/v1/dialogs?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (checkResponse.status === 401) {
                    const errorData = await checkResponse.json();
                    if (errorData.detail.includes("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram") || 
                        errorData.detail.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω–∞")) {
                        alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"');
                        return;
                    }
                }
                
                const response = await fetch('/api/v1/dialogs/832190149/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        text: '–•—Ä–µ–Ω'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ "–•—Ä–µ–Ω" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ:', data);
                    alert('–°–æ–æ–±—â–µ–Ω–∏–µ "–•—Ä–µ–Ω" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    const errorData = await response.json();
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', errorData);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
                    if (errorData.detail.includes("–°–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è") && 
                        errorData.detail.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω–∞")) {
                        alert('–û—à–∏–±–∫–∞: –°–µ—Å—Å–∏—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"');
                    } else if (errorData.detail.includes("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram")) {
                        alert('–û—à–∏–±–∫–∞: –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"');
                    } else {
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${errorData.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
        function loadDialogs(forceRefresh = false) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ localStorage
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞, –∑–∞—Ç–µ–º —Å—Ç–∞—Ä—ã–π
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            
            if (!token) {
                showLoginForm();
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞–Ω–æ —Ä–∞–Ω–µ–µ
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'block';
            }

            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
            const dialogsList = document.getElementById('dialogs-list');
            dialogsList.innerHTML = '';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º force_refresh
            const url = `/api/v1/dialogs?force_refresh=${forceRefresh}`;
            
            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ —Å URL: ${url}`);
            
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                console.log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (response.status === 401) {
                    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram
                    return response.json().then(data => {
                        console.log('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data);
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (loading) {
                            loading.style.display = 'none';
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏
                        if (data.detail && typeof data.detail === 'object' && data.detail.session_info) {
                            const sessionInfo = data.detail.session_info;
                            console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏:', sessionInfo);
                            
                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
                            if (errorMessage) {
                                errorMessage.innerHTML = `
                                    <h3>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</h3>
                                    <p>${data.detail.error || '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}</p>
                                    <div class="debug-info">
                                        <h4>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                                        <ul>
                                            <li>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${sessionInfo.user_id}</li>
                                            <li>–ü—É—Ç—å –∫ —Å–µ—Å—Å–∏–∏: ${sessionInfo.session_path}</li>
                                            <li>–°–µ—Å—Å–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${sessionInfo.session_exists ? '–î–∞' : '–ù–µ—Ç'}</li>
                                            <li>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${sessionInfo.sessions_dir_exists ? '–î–∞' : '–ù–µ—Ç'}</li>
                                            <li>–°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π: ${sessionInfo.sessions_list.length > 0 ? sessionInfo.sessions_list.join(', ') : '–ü—É—Å—Ç–æ'}</li>
                                        </ul>
                                    </div>
                                    <button class="auth-button" onclick="showTelegramAuthForm()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram</button>
                                `;
                                errorMessage.style.display = 'block';
                            }
                        } else {
                            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                            if (errorMessage) {
                                errorMessage.innerHTML = `
                                    <p>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</p>
                                    <button class="auth-button" onclick="showTelegramAuthForm()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram</button>
                                `;
                                errorMessage.style.display = 'block';
                            }
                        }
                        throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram');
                    });
                } else if (response.status === 429) {
                    // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
                    return response.json().then(data => {
                        console.log('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤:', data);
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (loading) {
                            loading.style.display = 'none';
                        }
                        
                        if (errorMessage) {
                            errorMessage.innerHTML = `
                                <h3>–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API Telegram</h3>
                                <p>${data.detail || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π.'}</p>
                                <button class="retry-button" onclick="loadDialogs(true)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                            `;
                            errorMessage.style.display = 'block';
                        }
                        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API Telegram');
                    });
                } else if (response.status === 403) {
                    // –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                    return response.json().then(data => {
                        console.log('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', data);
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (loading) {
                            loading.style.display = 'none';
                        }
                        
                        if (errorMessage) {
                            errorMessage.innerHTML = `
                                <h3>–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Telegram</h3>
                                <p>${data.detail || '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.'}</p>
                            `;
                            errorMessage.style.display = 'block';
                        }
                        throw new Error('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Telegram');
                    });
                } else if (!response.ok) {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    return response.json().then(data => {
                        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', data);
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (loading) {
                            loading.style.display = 'none';
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
                        let errorMsg = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤.';
                        let errorDetails = '';
                        
                        if (data.detail) {
                            if (typeof data.detail === 'object') {
                                errorMsg = data.detail.message || errorMsg;
                                errorDetails = `<pre>${JSON.stringify(data.detail, null, 2)}</pre>`;
                            } else {
                                errorMsg = data.detail;
                            }
                        }
                        
                        if (errorMessage) {
                            errorMessage.innerHTML = `
                                <h3>–û—à–∏–±–∫–∞</h3>
                                <p>${errorMsg}</p>
                                ${errorDetails}
                                <button class="retry-button" onclick="loadDialogs(true)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                            `;
                            errorMessage.style.display = 'block';
                        }
                        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤: ${errorMsg}`);
                    });
                }
                
                return response.json();
            })
            .then(dialogs => {
                console.log(`–ü–æ–ª—É—á–µ–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤: ${dialogs.length}`);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                lastDialogs = [...dialogs];
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                if (loading) {
                    loading.style.display = 'none';
                }
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
                dialogsList.innerHTML = '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const refreshButton = document.createElement('button');
                refreshButton.className = 'refresh-button';
                refreshButton.innerHTML = '–û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏';
                refreshButton.onclick = () => loadDialogs(true);
                dialogsList.appendChild(refreshButton);
                
                // –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (dialogs.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-message';
                    emptyMessage.innerHTML = '–£ –≤–∞—Å –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤';
                    dialogsList.appendChild(emptyMessage);
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                dialogs.forEach(dialog => {
                    const dialogItem = document.createElement('div');
                    dialogItem.className = 'dialog-item';
                    dialogItem.onclick = () => loadMessages(dialog.id, dialog.title);
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'dialog-avatar';
                    if (dialog.photo) {
                        avatar.innerHTML = `<img src="${dialog.photo}" alt="${dialog.title}">`;
                    } else {
                        avatar.innerHTML = `<div class="avatar-placeholder">${dialog.title.charAt(0)}</div>`;
                    }
                    
                    const info = document.createElement('div');
                    info.className = 'dialog-info';
                    
                    const title = document.createElement('div');
                    title.className = 'dialog-title';
                    title.textContent = dialog.title;
                    
                    const lastMessage = document.createElement('div');
                    lastMessage.className = 'dialog-last-message';
                    lastMessage.textContent = dialog.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    
                    info.appendChild(title);
                    info.appendChild(lastMessage);
                    
                    const meta = document.createElement('div');
                    meta.className = 'dialog-meta';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    if (dialog.last_message_date) {
                        const time = document.createElement('div');
                        time.className = 'dialog-time';
                        const date = new Date(dialog.last_message_date);
                        time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        meta.appendChild(time);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (dialog.unread_count && dialog.unread_count > 0) {
                        const unread = document.createElement('div');
                        unread.className = 'dialog-unread';
                        unread.textContent = dialog.unread_count;
                        meta.appendChild(unread);
                    }
                    
                    dialogItem.appendChild(avatar);
                    dialogItem.appendChild(info);
                    dialogItem.appendChild(meta);
                    
                    dialogsList.appendChild(dialogItem);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª —Å –¥–∏–∞–ª–æ–≥–∞–º–∏
                document.getElementById('dialogs-section').style.display = 'block';
                // –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                document.getElementById('messages-section').style.display = 'none';
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', error);
                // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–ª–æ–∫–∞—Ö then
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function loadMessages(dialogId, dialogTitle) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
            currentDialogId = dialogId;
            
            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ ${dialogId}, –Ω–∞–∑–≤–∞–Ω–∏–µ: ${dialogTitle}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ localStorage
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            
            if (!token) {
                showLoginForm();
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('dialogs-section').style.display = 'none';
            const messagesSection = document.getElementById('messages-section');
            messagesSection.style.display = 'block';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∏–∞–ª–æ–≥–∞
            const dialogHeader = document.getElementById('current-dialog-header');
            dialogHeader.textContent = dialogTitle;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ - –¥–æ–±–∞–≤–ª—è–µ–º force_refresh=true
                const url = `/api/v1/messages/${dialogId}?limit=50&offset=0&force_refresh=true`;
                
                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                console.log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (response.status === 401) {
                    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram
                    const data = await response.json();
                    console.log('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏
                    if (data.detail && typeof data.detail === 'object' && data.detail.session_info) {
                        const sessionInfo = data.detail.session_info;
                        console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏:', sessionInfo);
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
                        messagesList.innerHTML = `
                            <div class="error-message">
                                <h3>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</h3>
                                <p>${data.detail.error || '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}</p>
                                <div class="debug-info">
                                    <h4>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                                    <ul>
                                        <li>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${sessionInfo.user_id}</li>
                                        <li>–ü—É—Ç—å –∫ —Å–µ—Å—Å–∏–∏: ${sessionInfo.session_path}</li>
                                        <li>–°–µ—Å—Å–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${sessionInfo.session_exists ? '–î–∞' : '–ù–µ—Ç'}</li>
                                        <li>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${sessionInfo.sessions_dir_exists ? '–î–∞' : '–ù–µ—Ç'}</li>
                                        <li>–°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π: ${sessionInfo.sessions_list.length > 0 ? sessionInfo.sessions_list.join(', ') : '–ü—É—Å—Ç–æ'}</li>
                                    </ul>
                                </div>
                                <button class="auth-button" onclick="showTelegramAuthForm()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram</button>
                            </div>
                        `;
                    } else {
                        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                        messagesList.innerHTML = `
                            <div class="error-message">
                                <p>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</p>
                                <button class="auth-button" onclick="showTelegramAuthForm()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram</button>
                            </div>
                        `;
                    }
                    return;
                } else if (response.status === 429) {
                    // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
                    const data = await response.json();
                    console.log('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤:', data);
                    messagesList.innerHTML = `
                        <div class="error-message">
                            <h3>–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API Telegram</h3>
                            <p>${data.detail || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π.'}</p>
                            <button class="retry-button" onclick="loadMessages('${dialogId}', '${dialogTitle}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </div>
                    `;
                    return;
                } else if (!response.ok) {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    const data = await response.json();
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
                    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π.';
                    let errorDetails = '';
                    
                    if (data.detail) {
                        if (typeof data.detail === 'object') {
                            errorMessage = data.detail.message || errorMessage;
                            errorDetails = `<pre>${JSON.stringify(data.detail, null, 2)}</pre>`;
                        } else {
                            errorMessage = data.detail;
                        }
                    }
                    
                    messagesList.innerHTML = `
                        <div class="error-message">
                            <h3>–û—à–∏–±–∫–∞</h3>
                            <p>${errorMessage}</p>
                            ${errorDetails}
                            <button class="retry-button" onclick="loadMessages('${dialogId}', '${dialogTitle}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                        </div>
                    `;
                    return;
                }
                
                const messages = await response.json();
                console.log(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messages.length}`);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                lastMessages = [...messages];
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                messagesList.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
                const messagesContainer = document.createElement('div');
                messagesContainer.className = 'messages-container';
                messagesList.appendChild(messagesContainer);
                
                // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (messages.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-message';
                    emptyMessage.innerHTML = '–í —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    messagesContainer.appendChild(emptyMessage);
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                messages.forEach(message => {
                    const messageItem = document.createElement('div');
                    messageItem.className = `message-item ${message.out ? 'outgoing' : 'incoming'}`;
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
                    if (!message.out && message.sender) {
                        const avatar = document.createElement('div');
                        avatar.className = 'message-avatar';
                        
                        if (message.sender.photo) {
                            avatar.innerHTML = `<img src="${message.sender.photo}" alt="${message.sender.first_name || 'User'}">`;
                        } else {
                            const initials = message.sender.first_name ? message.sender.first_name.charAt(0) : '?';
                            avatar.innerHTML = `<div class="avatar-placeholder">${initials}</div>`;
                        }
                        
                        messageItem.appendChild(avatar);
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
                    if (!message.out && message.sender) {
                        const senderName = document.createElement('div');
                        senderName.className = 'message-sender';
                        senderName.textContent = message.sender.first_name || 'Unknown';
                        if (message.sender.last_name) {
                            senderName.textContent += ` ${message.sender.last_name}`;
                        }
                        content.appendChild(senderName);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                    const text = document.createElement('div');
                    text.className = 'message-text';
                    text.textContent = message.text || '';
                    content.appendChild(text);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
                    const time = document.createElement('div');
                    time.className = 'message-time';
                    if (message.date) {
                        const date = new Date(message.date);
                        time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    content.appendChild(time);
                    
                    messageItem.appendChild(content);
                    messagesContainer.appendChild(messageItem);
                });
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                messagesList.innerHTML = `
                    <div class="error-message">
                        <h3>–û—à–∏–±–∫–∞</h3>
                        <p>${error.message}</p>
                        <button class="retry-button" onclick="loadMessages('${dialogId}', '${dialogTitle}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        function logout() {
            // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã
            localStorage.removeItem('token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            if (window.updateCheckingIntervalId) {
                clearInterval(window.updateCheckingIntervalId);
                window.updateCheckingIntervalId = null;
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            currentDialogId = null;
            lastDialogs = [];
            lastMessages = [];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            showLoginForm();
        }
        
        // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
        const phoneAuthData = {
            temp_user_id: null,
            phone: null,
            phone_code_hash: null
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function initAuthTabs() {
            const tabButtons = document.querySelectorAll('.auth-tab-button');
            const tabPanes = document.querySelectorAll('.auth-tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ø–∞–Ω–µ–ª–µ–π
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
                    this.classList.add('active');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–∞–Ω–µ–ª—å
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
        function initPhoneAuth() {
            const sendCodeButton = document.getElementById('send-code-button');
            const verifyCodeButton = document.getElementById('verify-code-button');
            const verifyPasswordButton = document.getElementById('verify-password-button');
            const backToPhoneButton = document.getElementById('back-to-phone-button');
            const backToCodeButton = document.getElementById('back-to-code-button');
            
            if (sendCodeButton) {
                sendCodeButton.addEventListener('click', async function() {
                    const phoneNumber = document.getElementById('phone-number').value;
                    if (!phoneNumber) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                        return;
                    }
                    
                    try {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        sendCodeButton.disabled = true;
                        sendCodeButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        const response = await fetch(`${window.location.origin}/api/v1/auth/send-code`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                phone_number: phoneNumber
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', data);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        phoneAuthData.phone = phoneNumber;
                        phoneAuthData.phone_code_hash = data.phone_code_hash;
                        phoneAuthData.temp_user_id = data.temp_user_id;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                        if (data.message) {
                            alert(data.message);
                        }
                        
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
                        document.getElementById('phone-step').style.display = 'none';
                        document.getElementById('code-step').style.display = 'block';
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞: ${error.message}`);
                    } finally {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        sendCodeButton.disabled = false;
                        sendCodeButton.textContent = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
                    }
                });
            }
            
            if (verifyCodeButton) {
                verifyCodeButton.addEventListener('click', async function() {
                    const code = document.getElementById('confirmation-code').value;
                    if (!code) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                        return;
                    }
                    
                    try {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        verifyCodeButton.disabled = true;
                        verifyCodeButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        const response = await fetch(`${window.location.origin}/api/v1/auth/sign-in`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                temp_user_id: phoneAuthData.temp_user_id,
                                phone_number: phoneAuthData.phone,
                                code: code,
                                phone_code_hash: phoneAuthData.phone_code_hash
                            })
                        });
                        
                        if (response.status === 401) {
                            // –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                            document.getElementById('code-step').style.display = 'none';
                            document.getElementById('password-step').style.display = 'block';
                            return;
                        }
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        updateUI(true);
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                        loadDialogs();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞: ${error.message}`);
                    } finally {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        verifyCodeButton.disabled = false;
                        verifyCodeButton.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥';
                    }
                });
            }
            
            if (verifyPasswordButton) {
                verifyPasswordButton.addEventListener('click', async function() {
                    const password = document.getElementById('auth-password').value;
                    if (!password) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                        return;
                    }
                    
                    try {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        verifyPasswordButton.disabled = true;
                        verifyPasswordButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        const response = await fetch(`${window.location.origin}/api/v1/auth/sign-in-2fa`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                temp_user_id: phoneAuthData.temp_user_id,
                                phone_number: phoneAuthData.phone,
                                code: document.getElementById('confirmation-code').value,
                                phone_code_hash: phoneAuthData.phone_code_hash,
                                password: password
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å 2FA:', data);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        updateUI(true);
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                        loadDialogs();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è: ${error.message}`);
                    } finally {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        verifyPasswordButton.disabled = false;
                        verifyPasswordButton.textContent = '–í–æ–π—Ç–∏';
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥"
            if (backToPhoneButton) {
                backToPhoneButton.addEventListener('click', function() {
                    document.getElementById('code-step').style.display = 'none';
                    document.getElementById('phone-step').style.display = 'block';
                });
            }
            
            if (backToCodeButton) {
                backToCodeButton.addEventListener('click', function() {
                    document.getElementById('password-step').style.display = 'none';
                    document.getElementById('code-step').style.display = 'block';
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            initAuthTabs();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('logout-button').addEventListener('click', function() {
                logout();
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –∫ –¥–∏–∞–ª–æ–≥–∞–º"
            document.getElementById('back-to-dialogs').addEventListener('click', () => {
                document.getElementById('messages-section').style.display = 'none';
                document.getElementById('dialogs-section').style.display = 'block';
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');
            
            if (messageInput && sendButton) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && messageInput.value.trim()) {
                        sendMessage();
                    }
                });
                
                sendButton.addEventListener('click', () => {
                    if (messageInput.value.trim()) {
                        sendMessage();
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            // –í–∞–∂–Ω–æ: updateUI —Å–∞–º–∞ –≤—ã–∑–æ–≤–µ—Ç loadDialogs, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            updateUI();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const keyInput = document.getElementById('enigma-key');
            const text = messageInput.value.trim();
            const key = keyInput.value;
            
            if (!text || !key) return;
            
            try {
                // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const encryptedText = enigmaEncrypt(text, key);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –∑–∞–º–∫–∞ –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç
                const botLink = 'https://t.me/enigma_railway_bot';
                const finalMessage = `üîí [Enigma](${botLink})\n${encryptedText}`;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π ID –¥–∏–∞–ª–æ–≥–∞
                const dialogId = currentDialogId;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const response = await fetch(`${window.location.origin}/api/v1/dialogs/${dialogId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        text: finalMessage
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                messageInput.value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                await loadMessages(dialogId, document.getElementById('current-dialog-header').textContent);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º –≠–Ω–∏–≥–º—ã
        function enigmaEncrypt(text, key) {
            // –ê–ª—Ñ–∞–≤–∏—Ç –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (—Ä—É—Å—Å–∫–∏–µ, –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)
            const alphabet = '–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—èABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª—é—á –≤ —á–∏—Å–ª–æ–≤—ã–µ —Å–¥–≤–∏–≥–∏
            const shifts = [];
            for (let i = 0; i < key.length; i++) {
                const charIndex = alphabet.indexOf(key[i]);
                if (charIndex !== -1) {
                    shifts.push(charIndex % 26 + 1); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å–¥–≤–∏–≥ –¥–æ 26
                } else {
                    shifts.push(1); // –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–ª—Ñ–∞–≤–∏—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–¥–≤–∏–≥ 1
                }
            }
            
            // –®–∏—Ñ—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            let result = '';
            let shiftIndex = 0;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charIndex = alphabet.indexOf(char);
                
                if (charIndex !== -1) {
                    // –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –µ—Å—Ç—å –≤ –∞–ª—Ñ–∞–≤–∏—Ç–µ, —à–∏—Ñ—Ä—É–µ–º –µ–≥–æ
                    const shift = shifts[shiftIndex % shifts.length];
                    const newIndex = (charIndex + shift) % alphabet.length;
                    result += alphabet[newIndex];
                    shiftIndex++;
                } else {
                    // –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª–∞ –Ω–µ—Ç –≤ –∞–ª—Ñ–∞–≤–∏—Ç–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    result += char;
                }
            }
            
            return result;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è –ø–æ–ª—è –∫–ª—é—á–∞
        document.addEventListener('DOMContentLoaded', function() {
            const keyInput = document.getElementById('enigma-key');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');
            const validationMessage = document.getElementById('key-validation-message');
            
            if (keyInput) {
                keyInput.addEventListener('input', function() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)
                    const value = this.value;
                    const regex = /^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9]*$/;
                    
                    if (!regex.test(value)) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã, —É–¥–∞–ª—è–µ–º –∏—Ö
                        this.value = value.replace(/[^–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9]/g, '');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∫–ª—é—á–∞
                    if (this.value.length === 5) {
                        // –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ –∫–ª—é—á–∞ —Ä–∞–≤–Ω–∞ 5, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                        messageInput.disabled = false;
                        sendButton.disabled = false;
                        validationMessage.textContent = '';
                        validationMessage.style.color = 'green';
                    } else {
                        // –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ –∫–ª—é—á–∞ –Ω–µ —Ä–∞–≤–Ω–∞ 5, –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                        messageInput.disabled = true;
                        sendButton.disabled = true;
                        validationMessage.textContent = `–í–≤–µ–¥–∏—Ç–µ —Ä–æ–≤–Ω–æ 5 —Å–∏–º–≤–æ–ª–æ–≤ (${this.value.length}/5)`;
                        validationMessage.style.color = 'red';
                    }
                });
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        let currentDialogId = null;
        let lastDialogs = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
        let lastMessages = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        let isCheckingForUpdates = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function startUpdateChecking() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (window.updateCheckingIntervalId) {
                clearInterval(window.updateCheckingIntervalId);
                window.updateCheckingIntervalId = null;
                console.log('–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            if (!token) {
                console.log('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞');
                return;
            }
            
            console.log('–ó–∞–ø—É—â–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            const intervalId = setInterval(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                const currentToken = localStorage.getItem('token') || localStorage.getItem('access_token');
                if (!currentToken) {
                    console.log('–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π');
                    clearInterval(intervalId);
                    window.updateCheckingIntervalId = null;
                    return;
                }
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥–∏–∞–ª–æ–≥, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (currentDialogId) {
                    checkForNewMessages();
                } else {
                    // –ò–Ω–∞—á–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏
                    checkForNewDialogs();
                }
            }, 5000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –±—É–¥—É—â–µ–º
            window.updateCheckingIntervalId = intervalId;
            console.log('ID –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', intervalId);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        async function checkForNewMessages() {
            if (isCheckingForUpdates || !currentDialogId) return;
            isCheckingForUpdates = true;
            
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('access_token');
                if (!token) {
                    console.log('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–º–µ–Ω–µ–Ω–∞');
                    isCheckingForUpdates = false;
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
                    if (window.updateCheckingIntervalId) {
                        clearInterval(window.updateCheckingIntervalId);
                        window.updateCheckingIntervalId = null;
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞');
                    }
                    
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º force_refresh=true –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const url = `/api/v1/messages/${currentDialogId}?limit=50&offset=0&force_refresh=true`;
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª–∏
                    console.log('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–º–µ–Ω–µ–Ω–∞');
                    isCheckingForUpdates = false;
                    
                    // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
                    localStorage.removeItem('token');
                    localStorage.removeItem('access_token');
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
                    if (window.updateCheckingIntervalId) {
                        clearInterval(window.updateCheckingIntervalId);
                        window.updateCheckingIntervalId = null;
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    showLoginForm();
                    
                    return;
                }
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', response.status, response.statusText);
                    isCheckingForUpdates = false;
                    return;
                }
                
                const messages = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', messages.length);
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã—Ö–æ–¥–∏–º
                if (messages.length === 0 || !lastMessages || lastMessages.length === 0) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    if (!lastMessages || lastMessages.length === 0) {
                        lastMessages = [...messages];
                    }
                    isCheckingForUpdates = false;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                let hasNewMessages = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
                if (messages.length !== lastMessages.length) {
                    console.log('–ò–∑–º–µ–Ω–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length, lastMessages.length);
                    hasNewMessages = true;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const lastMessage = messages[messages.length - 1];
                    const prevLastMessage = lastMessages[lastMessages.length - 1];
                    
                    if (lastMessage.id !== prevLastMessage.id) {
                        console.log('–ò–∑–º–µ–Ω–∏–ª—Å—è ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', lastMessage.id, prevLastMessage.id);
                        hasNewMessages = true;
                    } else if (lastMessage.text !== prevLastMessage.text) {
                        console.log('–ò–∑–º–µ–Ω–∏–ª—Å—è —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', lastMessage.text, prevLastMessage.text);
                        hasNewMessages = true;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –≤—ã—Ö–æ–¥–∏–º
                if (!hasNewMessages) {
                    isCheckingForUpdates = false;
                    return;
                }
                
                console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                lastMessages = [...messages];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await loadMessages(currentDialogId, document.getElementById('current-dialog-header').textContent);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            } finally {
                isCheckingForUpdates = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
        async function checkForNewDialogs() {
            if (isCheckingForUpdates || currentDialogId) return;
            isCheckingForUpdates = true;
            
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('access_token');
                if (!token) {
                    console.log('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                    isCheckingForUpdates = false;
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
                    if (window.updateCheckingIntervalId) {
                        clearInterval(window.updateCheckingIntervalId);
                        window.updateCheckingIntervalId = null;
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞');
                    }
                    
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º force_refresh=true –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const url = `/api/v1/dialogs?force_refresh=true`;
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª–∏
                    console.log('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                    isCheckingForUpdates = false;
                    
                    // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
                    localStorage.removeItem('token');
                    localStorage.removeItem('access_token');
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
                    if (window.updateCheckingIntervalId) {
                        clearInterval(window.updateCheckingIntervalId);
                        window.updateCheckingIntervalId = null;
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    showLoginForm();
                    
                    return;
                }
                
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', response.status, response.statusText);
                    isCheckingForUpdates = false;
                    return;
                }
                
                const dialogs = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', dialogs.length);
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤ –∏–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã—Ö–æ–¥–∏–º
                if (dialogs.length === 0 || !lastDialogs || lastDialogs.length === 0) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥–∏
                    if (!lastDialogs || lastDialogs.length === 0) {
                        lastDialogs = [...dialogs];
                    }
                    isCheckingForUpdates = false;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
                let hasChanges = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤
                if (dialogs.length !== lastDialogs.length) {
                    console.log('–ò–∑–º–µ–Ω–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤:', dialogs.length, lastDialogs.length);
                    hasChanges = true;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                    for (let i = 0; i < dialogs.length; i++) {
                        const dialog = dialogs[i];
                        const lastDialog = lastDialogs[i];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º ID –¥–∏–∞–ª–æ–≥–∞
                        if (dialog.id !== lastDialog.id) {
                            console.log('–ò–∑–º–µ–Ω–∏–ª—Å—è ID –¥–∏–∞–ª–æ–≥–∞:', dialog.id, lastDialog.id);
                            hasChanges = true;
                            break;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                        if (dialog.unread_count !== lastDialog.unread_count) {
                            console.log('–ò–∑–º–µ–Ω–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', dialog.unread_count, lastDialog.unread_count);
                            hasChanges = true;
                            break;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (dialog.last_message && lastDialog.last_message) {
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏—Ö ID
                            if (dialog.last_message !== lastDialog.last_message) {
                                console.log('–ò–∑–º–µ–Ω–∏–ª–æ—Å—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', dialog.last_message, lastDialog.last_message);
                                hasChanges = true;
                                break;
                            }
                        } else if (dialog.last_message || lastDialog.last_message) {
                            // –ï—Å–ª–∏ —É –æ–¥–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ —É –¥—Ä—É–≥–æ–≥–æ –Ω–µ—Ç
                            console.log('–ü–æ—è–≤–∏–ª–æ—Å—å –∏–ª–∏ –∏—Å—á–µ–∑–ª–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                            hasChanges = true;
                            break;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã—Ö–æ–¥–∏–º
                if (!hasChanges) {
                    isCheckingForUpdates = false;
                    return;
                }
                
                console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                lastDialogs = [...dialogs];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                loadDialogs(false);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤:', error);
            } finally {
                isCheckingForUpdates = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function manualAuth(userId) {
            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º —Ä—É—á–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è ID:', userId);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π URL —Å HTTPS
                const apiUrl = `${window.location.origin}/api/v1/auth/manual`;
                console.log('URL –¥–ª—è —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: userId,
                        first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        username: 'test_user'
                    })
                });
                
                console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data);
                
                if (data.access_token) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateUI(true);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                    loadDialogs();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateAuthDebugInfo();
                    
                    return data;
                } else {
                    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É)
        function directAuth() {
            const userId = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è –ø—Ä—è–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:');
            if (!userId) return;
            
            console.log('–ü—Ä—è–º–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è ID:', userId);
            
            // –°–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω
            const token = `test_token_${userId}`;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
            localStorage.setItem('access_token', token);
            localStorage.setItem('user', JSON.stringify({
                id: userId,
                first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: 'test_user'
            }));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI(true);
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ª–Ω–æ–≥–æ URL
                const apiUrl = `${window.location.origin}/api/v1/dialogs`;
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ —Å URL –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', apiUrl);
                
                fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', response);
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏:', data);
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                    const dialogsList = document.getElementById('dialogs-list');
                    if (dialogsList) {
                        dialogsList.innerHTML = '';
                        if (data.length === 0) {
                            dialogsList.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p>';
                        } else {
                            data.forEach(dialog => {
                                const dialogElement = document.createElement('div');
                                dialogElement.className = 'dialog-card';
                                dialogElement.innerHTML = `
                                    <div class="dialog-header">
                                        <div class="dialog-avatar"></div>
                                        <div class="dialog-name">${dialog.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                        ${dialog.unread_count ? `<div class="unread-badge">${dialog.unread_count}</div>` : ''}
                                    </div>
                                    <div class="dialog-last-message">${dialog.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                                    <div class="dialog-time">${dialog.last_message_date || ''}</div>
                                `;
                                dialogsList.appendChild(dialogElement);
                            });
                        }
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) {
                        errorMessage.textContent = error.message;
                        errorMessage.style.display = 'block';
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:', error);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updateAuthDebugInfo();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthDebugInfo() {
            const authDebugInfo = document.getElementById('auth-debug-info');
            if (!authDebugInfo) return;
            
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    authDebugInfo.innerHTML = `
                        <h4>–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h4>
                        <pre>${token}</pre>
                        <h4>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h4>
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–ø–∫–µ
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = userData.first_name || userData.username || userData.id;
                    }
                } catch (error) {
                    authDebugInfo.innerHTML = `
                        <h4>–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h4>
                        <pre>${token}</pre>
                        <h4>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h4>
                        <pre>${error.message}</pre>
                    `;
                }
            } else {
                authDebugInfo.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateUI(isAuthenticated) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', isAuthenticated);
            
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if (isAuthenticated === undefined) {
                const token = localStorage.getItem('token') || localStorage.getItem('access_token');
                isAuthenticated = !!token;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const authSection = document.getElementById('auth-section');
            const dialogsSection = document.getElementById('dialogs-section');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const errorMessage = document.getElementById('error-message');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (isAuthenticated) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (authSection) authSection.style.display = 'none';
                if (dialogsSection) dialogsSection.style.display = 'block';
                if (userInfo) userInfo.style.display = 'block';
                if (errorMessage) errorMessage.style.display = 'none';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (userName && user.first_name) {
                    userName.textContent = user.first_name;
                    if (user.last_name) {
                        userName.textContent += ' ' + user.last_name;
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                loadDialogs();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                startUpdateChecking();
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (authSection) authSection.style.display = 'block';
                if (dialogsSection) dialogsSection.style.display = 'none';
                if (userInfo) userInfo.style.display = 'none';
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
                const dialogsList = document.getElementById('dialogs-list');
                if (dialogsList) dialogsList.innerHTML = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updateAuthDebugInfo();
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram
        window.telegramLogin = function(user) {
            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç Telegram:', user);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π URL —Å HTTPS
            const apiUrl = `${window.location.origin}/api/v1/auth/telegram`;
            console.log('URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram:', apiUrl);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            })
            .then(response => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç–∞—Ç—É—Å):', response.status);
                return response.json();
            })
            .then(data => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–¥–∞–Ω–Ω—ã–µ):', data);
                
                if (data.access_token) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateUI(true);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
                    loadDialogs();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateAuthDebugInfo();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ' + error.message);
            });
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–π Telegram
        async function checkTelegramSessions() {
            const sessionsDebugInfo = document.getElementById('sessions-debug-info');
            if (!sessionsDebugInfo) return;
            
            try {
                sessionsDebugInfo.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏—è—Ö...</p>';
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    sessionsDebugInfo.innerHTML = '<p>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–π</p>';
                    return;
                }
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö
                const response = await fetch('/api/v1/auth/sessions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // –ï—Å–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
                        await checkSessionsAlternative(sessionsDebugInfo);
                        return;
                    }
                    
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏—è—Ö: ${response.status}`);
                }
                
                const data = await response.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö
                sessionsDebugInfo.innerHTML = `
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏—è—Ö Telegram:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–π:', error);
                sessionsDebugInfo.innerHTML = `
                    <h4>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–π:</h4>
                    <pre>${error.message}</pre>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏:</p>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                const alternativeButton = document.createElement('button');
                alternativeButton.className = 'auth-button';
                alternativeButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º';
                alternativeButton.addEventListener('click', function() {
                    checkSessionsAlternative(sessionsDebugInfo);
                });
                sessionsDebugInfo.appendChild(alternativeButton);
            }
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–π
        async function checkSessionsAlternative(sessionsDebugInfo) {
            try {
                sessionsDebugInfo.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º...</p>';
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    sessionsDebugInfo.innerHTML = '<p>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–π</p>';
                    return;
                }
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ª–∏–º–∏—Ç–æ–º
                const response = await fetch('/api/v1/dialogs?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const responseData = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏
                const isMockData = response.ok && responseData.some(dialog => 
                    dialog.title && (dialog.title.includes('–¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥') || dialog.title.includes('–°–ª—É—á–∞–π–Ω—ã–π –¥–∏–∞–ª–æ–≥'))
                );
                
                let sessionStatus = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                let sessionDetails = '';
                
                if (!response.ok) {
                    if (responseData.detail && responseData.detail.includes('–°–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è') && 
                        responseData.detail.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω–∞')) {
                        sessionStatus = '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                        sessionDetails = responseData.detail;
                    } else if (responseData.detail && responseData.detail.includes('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram')) {
                        sessionStatus = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                        sessionDetails = responseData.detail;
                    } else {
                        sessionStatus = '–û—à–∏–±–∫–∞';
                        sessionDetails = responseData.detail || `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    }
                } else if (isMockData) {
                    sessionStatus = '–í–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                    sessionDetails = '–í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö';
                } else {
                    sessionStatus = '–ê–∫—Ç–∏–≤–Ω–∞';
                    sessionDetails = '–°–µ—Å—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const user = localStorage.getItem('user');
                let userData = { id: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
                
                if (user) {
                    try {
                        userData = JSON.parse(user);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
                sessionsDebugInfo.innerHTML = `
                    <h4>–°—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ Telegram:</h4>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${sessionStatus}</p>
                    <p><strong>–î–µ—Ç–∞–ª–∏:</strong> ${sessionDetails}</p>
                    <p><strong>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${userData.id}</p>
                    <p><strong>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π:</strong> <code>${responseData.detail && responseData.detail.session_info ? responseData.detail.session_info.sessions_dir : '[–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö]'}</code></p>
                    <p><strong>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–µ—Å—Å–∏–∏:</strong> <code>${responseData.detail && responseData.detail.session_info ? responseData.detail.session_info.session_path : `[–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö] (–æ–∂–∏–¥–∞–µ—Ç—Å—è: user_${userData.id}.session)`}</code></p>
                    <p><strong>–°–µ—Å—Å–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:</strong> ${responseData.detail && responseData.detail.session_info ? (responseData.detail.session_info.session_exists ? '–î–∞' : '–ù–µ—Ç') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    <p><strong>–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏:</strong> ${responseData.detail && responseData.detail.session_info ? `${responseData.detail.session_info.session_size} –±–∞–π—Ç` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    <p><strong>–ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å:</strong> ${responseData.detail && responseData.detail.session_info ? (responseData.detail.session_info.write_permission ? '–ï—Å—Ç—å' : '–ù–µ—Ç') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    <p><strong>Railway Volume:</strong> ${responseData.detail && responseData.detail.session_info && responseData.detail.session_info.is_railway ? 
                        (responseData.detail.session_info.railway_volume || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω') : '–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è'}</p>
                    <p><strong>–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ API:</strong> ${response.status} ${response.statusText}</p>
                    <pre>${JSON.stringify(responseData, null, 2)}</pre>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                if (sessionStatus !== '–ê–∫—Ç–∏–≤–Ω–∞') {
                    const recommendations = document.createElement('div');
                    recommendations.innerHTML = `
                        <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
                        <ol>
                            <li>–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"</li>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–≤–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</li>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</li>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏</li>
                        </ol>
                    `;
                    sessionsDebugInfo.appendChild(recommendations);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                    const authButton = document.createElement('button');
                    authButton.className = 'auth-button';
                    authButton.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É';
                    authButton.addEventListener('click', function() {
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                        document.querySelector('.auth-tab-button[data-tab="phone-tab"]').click();
                    });
                    sessionsDebugInfo.appendChild(authButton);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–π:', error);
                sessionsDebugInfo.innerHTML = `
                    <h4>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–π:</h4>
                    <pre>${error.message}</pre>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            const authDebugInfo = document.getElementById('auth-debug-info');
            if (!authDebugInfo) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ localStorage
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const userData = localStorage.getItem('user');
            
            let userObj = null;
            try {
                if (userData) {
                    userObj = JSON.parse(userData);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            let debugHtml = '<h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h4>';
            
            if (token) {
                debugHtml += `
                    <p><strong>–¢–æ–∫–µ–Ω:</strong> ${token.substring(0, 10)}...</p>
                `;
                
                if (userObj) {
                    debugHtml += `
                        <p><strong>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong></p>
                        <pre>${JSON.stringify(userObj, null, 2)}</pre>
                    `;
                } else {
                    debugHtml += '<p><strong>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                try {
                    const response = await fetch('/api/v1/auth/check', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        debugHtml += `
                            <p><strong>–°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞:</strong> –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</p>
                            <p><strong>–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:</strong></p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    } else {
                        debugHtml += `
                            <p><strong>–°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞:</strong> –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</p>
                            <p><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> ${response.status}</p>
                        `;
                    }
                } catch (e) {
                    debugHtml += `
                        <p><strong>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞:</strong> ${e.message}</p>
                    `;
                }
            } else {
                debugHtml += '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</p>';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º URL
            debugHtml += `
                <p><strong>–¢–µ–∫—É—â–∏–π URL:</strong> ${window.location.href}</p>
                <p><strong>Origin:</strong> ${window.location.origin}</p>
                <p><strong>API URL:</strong> ${window.location.origin}/api</p>
            `;
            
            authDebugInfo.innerHTML = debugHtml;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            initApp();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
            initPhoneAuth();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–ª–∞–¥–∫–∏
            const setWebhookButton = document.getElementById('set-webhook-button');
            if (setWebhookButton) {
                setWebhookButton.addEventListener('click', async function() {
                    try {
                        const webhookUrl = document.getElementById('webhook-url').value;
                        
                        const response = await fetch('/set-webhook', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                webhook_url: webhookUrl
                            })
                        });
                        
                        const data = await response.json();
                        alert(`–í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${JSON.stringify(data)}`);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–µ–±—Ö—É–∫–∞: ${error.message}`);
                    }
                });
            }
            
            const deleteWebhookButton = document.getElementById('delete-webhook-button');
            if (deleteWebhookButton) {
                deleteWebhookButton.addEventListener('click', async function() {
                    try {
                        const response = await fetch('/delete-webhook', {
                            method: 'POST'
                        });
                        
                        const data = await response.json();
                        alert(`–í–µ–±—Ö—É–∫ —É–¥–∞–ª–µ–Ω: ${JSON.stringify(data)}`);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞: ${error.message}`);
                    }
                });
            }
            
            const sendTestMessageButton = document.getElementById('send-test-message-button');
            if (sendTestMessageButton) {
                sendTestMessageButton.addEventListener('click', async function() {
                    try {
                        const chatId = document.getElementById('test-chat-id').value;
                        
                        if (!chatId) {
                            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞');
                            return;
                        }
                        
                        const response = await fetch('/send-test-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                chat_id: chatId
                            })
                        });
                        
                        const data = await response.json();
                        alert(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${JSON.stringify(data)}`);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`);
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            updateUI();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            startUpdateChecking();
        });
    </script>

    <script src="/static/js/app.js"></script>
</body>
</html> 